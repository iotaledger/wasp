// Copyright 2020 IOTA Stiftung
// SPDX-License-Identifier: Apache-2.0

package chain

import (
	"bytes"
	"context"
	"encoding/json"
	"fmt"
	"os"
	"strings"
	"time"

	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/samber/lo"
	"github.com/spf13/cobra"

	"github.com/iotaledger/wasp/clients"
	"github.com/iotaledger/wasp/clients/iota-go/iotaclient"
	"github.com/iotaledger/wasp/clients/iota-go/iotago"
	"github.com/iotaledger/wasp/clients/iota-go/iotajsonrpc"
	"github.com/iotaledger/wasp/clients/iscmove/iscmoveclient"
	"github.com/iotaledger/wasp/packages/cryptolib"
	"github.com/iotaledger/wasp/packages/isc"
	"github.com/iotaledger/wasp/packages/migration"
	"github.com/iotaledger/wasp/packages/parameters"
	"github.com/iotaledger/wasp/packages/transaction"
	"github.com/iotaledger/wasp/packages/util"
	"github.com/iotaledger/wasp/packages/vm/core/evm"
	"github.com/iotaledger/wasp/packages/vm/core/governance"
	"github.com/iotaledger/wasp/tools/wasp-cli/cli/cliclients"
	"github.com/iotaledger/wasp/tools/wasp-cli/cli/config"
	"github.com/iotaledger/wasp/tools/wasp-cli/cli/wallet"
	"github.com/iotaledger/wasp/tools/wasp-cli/cli/wallet/wallets"
	"github.com/iotaledger/wasp/tools/wasp-cli/log"
	cliutil "github.com/iotaledger/wasp/tools/wasp-cli/util"
	"github.com/iotaledger/wasp/tools/wasp-cli/waspcmd"
)

const TEST_TX = "0x0000280100fedde0edadb0a93d0b0e088fcd451002056240610deac0a45c976c5501efad510100000000000000205955bb963147b61845fd6a389f261a4fe8556b1423b273b420c228c6021a117f0102038efe4e4256d1533214f9fef07627bc7ac9300de1a083cede1fb8dc4de8653701000000000000002008cf2fedb49d105fea0ca81e208765ff41949ef553de87d005d18b3601cc33ea010205e6e690f89b97a1a293c53afb144dc99e43a6194e7790d8f87504285963db46010000000000000020f1ef6c7324f5ee9cfeba7ed366df0a54b29b273fd3b7a5ee92caa373c20d896d0102101a2c3b606d7be427140806700891abf2b752ef14979fcf35fda1c0a1c3530f010000000000000020574370cf8a51390b49acaedc5b52a54ca71a721fb8607e5ab28c424b125f5bc80102157a09b3058eba1776440cab9241d25db9b52fcb5f5934783e01608f126af8bc0100000000000000201c060fbc06f746cedb872ff6aadd07e2cb4a524a8fda6e1ca12fc8be51f931b001021bb4bd1c0d84d8e2a3bea769e770191ee4b63af236e19194b6e0c44b4bfad124010000000000000020ed47c904ddc8f953365c51c7c4a38e2fe124e7786e605ca4b5035a43067f5dd6010220a5b3e6edf9af39e813cec9f5e93e00138826d30c370d43c5a98cb827853c490100000000000000202c8e90518157c6ad59ef0c14d35cc26e3eea55abed8cceaab805bfd46fa9169b01022b141ffc879324ecd0879b67a7d41bdb167b0c0fecc4e6d6fce8dc0adffdfa7b010000000000000020ca774361f3e5307935c3cba9ccab821a4105b6b9449c74602c514c4806c27ce9010230f4eca6c88826b58ba8163d7c2f480a93ae1325da8510ea7d9bb3fb5e5383f40100000000000000209b1c9a294b420d5bd2ddbd9ddb03c0130dacc23e4e1a934382f8c63de4146c5e01023381348103505f075b1c84e7e54fe22570b06340ca1734dee27170fef9491f07010000000000000020600e5d8e97eeae073214cc62a5e6267572360d79da14442441121413e82014ae010234632afb34d4149a63ed0ad11a0be8fd3e879c1a30a11a9ec87f36f815160f57010000000000000020f4288094640d7cccc22b625434ee960cb3a8879cf37413967f776e16c0b95607010235e335b0ff5b0b3fe9a0ed338e0469741cf90f3ca963e51d48c99d939fa1779b010000000000000020eede27341d7991a06b86c99675c1e7abaa35c6c17f7843beb4a4020d0a844af00102473d69b8257510ffd0661fdad5354ae3ce993755283163e281049b5b692ea8300100000000000000209b140ce41175d04fa345d5ecbb4f58519753496a478ff8b9b12f7dc751fa946a01024ca0cdcf38d81d5a76abaa302f89d67ef5c19c26825f080366c590f7e1825f2601000000000000002009eb6f2e3ad391a368bb0c79dfebbd941a919dfe0920d0937de96115a8d4766b01024ec5d776db20bfeefe250a93f42d5cfb12776bd281bbfd388158b9fe38be57a601000000000000002033bdf389313e357aecdcd1cf1dd438a7268ee1c14d70d87430011b952272641e01025007986ef755dad4b99b63b73b0a81f321577129ac130d891b4b471b2e93523c01000000000000002045e72691def438ae9fa2d3fdcdc3447877a2cfb93ceba8a598c92e1f7302b1db01025b4bb762b313f9d6b392a281715ae5d0a3ed5ad731be73562c32c44ff25596e10100000000000000201a1eb518440397d21452806485d51975a2542021bcd14bb65b49c20356b64b3001025e44b09660ce75e4bd6ab10014826eb41efbd26de98b9583b9f3996b0295c7f5010000000000000020e5c67e6735c31c33f42a93b02cc654d42fe0b70f63201060dfd5a38c373c916001025fd22def08d13fe81d2d504ea102d69576f54499ffb32b3a8a4974e322288677010000000000000020ebef41a0923bc09f2ec8962d977468c2a685ca39730c19f944daa7276578338301026204e10c5e6e793c63d72c171d333379ec586212caad7d9f6eda2c08dbe5a010010000000000000020e1b7b723c137bad1feca488a59056c8c7b698082533c55fad61b8cc8fe78db200102766edb2e6369df8d4d74e5f5043104662039b0a41574733e8e2c67db68c67a76010000000000000020e6d998682a4c73acc02005ad8c9b4f082ceaf1fed7824b41b2e9f3fde25a4ce101028915db1cb82c3a641796da0f08a2b055152c797b6a7a22580a2d7cd22e553e5d010000000000000020653a834c9c834c7015b8edf7b02b743870756652595aeee9ab5249ead94f9b0301028d29386e2968fc9dc56726a2e335abe484f9da9ee97c0a5e9bb78798b14af2ad010000000000000020f8a0ed6ece458eed7c542970fa5f6b0a720b4012a716b9e1fccd443ceb50781601029d6675b3ed65ba35e9f82ee0c1f67766207997dfe03e54dc7075040b09def23f010000000000000020eac8f2227a738448f895aeb164f73c6b313aaa4a2cbea64088f7f14f6208f37e0102a1d14e00073ad26383cb48770d6502bd33b8bf13f099e46faed86aa0ee62f50d01000000000000002032cced17a21da1836219368abc4909046a3d84a9b0d1baf91f455907d890929c0102a3b6fee7926977328b48869fcd0d436156a63970fe6179cbef1a6727c92670f40100000000000000200aab3af187476bc007e694be8378b7a137da7beb7fc821ccaf21f55d1eac1cf00102a56a8742c7393e15124994d860951651730cb995a630befe062c25cc39572dbc0100000000000000208eb3392068cbc76fb9d557f4d9c19cbf6f873a3fd71696eec1fea0e22a1607a30102afdde99ffc2c818d7e3d4e6f8208dffc0ef8c8e1a95f10546e68210ee93c799c010000000000000020041838d8b2f674b106257308e2db9e5986208db864e5d190ff69f8270bc729f10102bdb34a400c242359419297a133b3be40f639075c8450b4fc1db4dd609f302866010000000000000020abad9ffe46fccdd1a55a056e7e5b81922d54cf022ae90bf0f3fed653bf98a7c40102bea03194a92d90cc2532f5520bcf84e125d943a21c09f79ebcc80f0a650ba116010000000000000020da625fa66536f295ac5e3c0757a0400ef993db408ba1f2a9cbc259da85e8b7820102bec5a43f26370b1f197b80fa9ed390ff31c8f64413395018bf48c90d4f7603cb0100000000000000201d9e9d4a1fa8322462f196941155ee1877c2b6e3e3b93c7cf8e88ec029cdb4300102c0dcb3bee1795b753507a36c134861544840cde289df1b197e5b6d6d8bbbeee4010000000000000020fc7499ed380ee32b85db0a2768619269785dabbc5e0b1fba83d24c2695fd8dbe0102c8cd19ff85f572977ae3e664d85321e0b4a3eb40cecec8ac6d5032c30c1009af0100000000000000209852d74bf58d830b5af00be464230b6483c9c953badc81a3160cbe46487394040102d82a8fe5c45c3bbd4e968c7c234eaf531943e37fe8a5602ff019cd8e3a7059f0010000000000000020200806373ac7719b5cc4a3607209e0c8a1145fc93184a4e479beb3c9ddf6cd9d0102e4ca6e64e7f337361e5eed2494a13a2119b49619b573a2d0e1eeef27ceab6bce0100000000000000200f7dfd4b05b7bd24756f02403261d6620758d614c76c95ae5891d316348ef5ef0102e85fcec8619561bfb119cd8e0a4114a443180e687795976654324a8d95edb25c0100000000000000209055cedbcfd0087f0d16baafb826e33c0cce357b7f2c1ef0cb23cb096d00ab0f0102eba357385efe242e0eae1aec6242319777d95bc811b4d7085f7824e9ae6f9642010000000000000020b76c332a5427bf674603c52efb37dd3c171c61659ffc38629b145a0b90928f870102f27250cdb4c0af035f4ef26bd2d66e833a0769a25a8ca0b6aeb0e8fc7f80573201000000000000002098ee4dc1c407a1d91ea40186caa4ae9c0cb0634d6108b9b11433a7b202a83aef0102fe596ae8762fa179558835529d4ffa01e01f1ed36b288cf21fccf7a9043a48e7010000000000000020b8745c28ef4abc000b131b5d5e02b14ebf9e7135731a48bf60bd1249f80e630d0102ffbeec7d1320d20096eb8423c94e4c55684463f0bc5dc2172aacfaabf802ccc3010000000000000020c16d15700eb67c79525bc7c22032b0068122fa8911948a21d6dd944e623dcd1fef01007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f626167036e6577000000000000000000000000000000000000000000000000000000000000000000107a0c616c6961735f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000101000000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010301000000007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000020200000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001030100010000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001010000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102050000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010306000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010306000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000020700007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000030600020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001020000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001020b0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001030c000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001030c000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000020d00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000030c00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001030000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102110000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010312000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010312000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000021300007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000031200020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001040000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102170000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010318000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010318000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000021900007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000031800020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001050000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001021d0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001031e000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001031e000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000021f00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000031e00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001060000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102230000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010324000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010324000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000022500007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000032400020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001070000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102290000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001032a000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001032a000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000022b00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000032a00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001080000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001022f0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010330000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010330000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000023100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000033000020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001090000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102350000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010336000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010336000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000023700007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000033600020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010a0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001023b0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001033c000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001033c000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000023d00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000033c00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010b0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102410000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010342000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010342000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000024300007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000034200020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010c0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102470000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010348000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010348000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000024900007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000034800020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010d0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001024d0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001034e000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001034e000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000024f00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000034e00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010e0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102530000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010354000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010354000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000025500007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000035400020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200010f0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102590000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001035a000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001035a000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000025b00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000035a00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001100000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001025f0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010360000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010360000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000026100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000036000020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001110000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102650000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010366000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010366000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000026700007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000036600020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001120000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001026b0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001036c000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001036c000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000026d00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000036c00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001130000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102710000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010372000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010372000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000027300007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000037200020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001140000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102770000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010378000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010378000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000027900007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000037800020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001150000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001027d0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001037e000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001037e000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000027f00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000037e00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001160000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102830000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010384000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010384000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000028500007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000038400020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001170000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102890000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001038a000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001038a000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000028b00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000038a00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001180000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001028f0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010390000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010390000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000029100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000039000020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001190000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102950000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100010396000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d70747900010396000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000029700007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000039600020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011a0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001029b0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410001039c000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d7074790001039c000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002020000029d00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f61737365740002020000039c00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011b0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102a10000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103a2000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103a2000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002a300007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003a200020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011c0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102a70000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103a8000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103a8000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002a900007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003a800020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011d0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102ad0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103ae000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103ae000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002af00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003ae00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011e0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102b30000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103b4000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103b4000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002b500007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003b400020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f544100020301000200011f0000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102b90000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103ba000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103ba000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002bb00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003ba00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001200000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102bf0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103c0000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103c0000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002c100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003c000020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001210000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102c50000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103c6000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103c6000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002c700007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003c600020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001220000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102cb0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103cc000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103cc000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002cd00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003cc00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001230000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102d10000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103d2000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103d2000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002d300007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003d200020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001240000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102d70000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103d8000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103d8000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002d900007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003d800020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001250000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102dd0000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103de000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103de000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002df00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003de00020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001260000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102e30000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103e4000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103e4000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002e500007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003e400020000000000000000000000000000000000000000000000000000000000000000107a18616464726573735f756e6c6f636b5f636f6e646974696f6e1e756e6c6f636b5f616c6961735f616464726573735f6f776e65645f6e66740107000000000000000000000000000000000000000000000000000000000000000204696f746104494f54410002030100020001270000000000000000000000000000000000000000000000000000000000000000107a0a6e66745f6f75747075740e657874726163745f6173736574730107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000102e90000000000000000000000000000000000000000000000000000000000000000000204636f696e0c66726f6d5f62616c616e63650107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000103ea000000000000000000000000000000000000000000000000000000000000000000000002036261670d64657374726f795f656d707479000103ea000100007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670a706c6163655f636f696e0107000000000000000000000000000000000000000000000000000000000000000204696f746104494f5441000202000002eb00007d3d624a85b43914debcd2187e5a2bdb74e5d56ac55a13654d0cdd9b8feb94a20a6173736574735f6261670b706c6163655f6173736574000202000003ea00020070bc12d8964837afac5978b4e3acc61defe9427e0c975afb1f3663c186e3b1e601de4467ed9677cd7c9ca649fc6a9b825fcd2fbfc81ab3c3d8f316934457454b4c010000000000000020ec125b5ca9ca045cf88da48b1518ca94674307868d027913e246955915fa860270bc12d8964837afac5978b4e3acc61defe9427e0c975afb1f3663c186e3b1e6e80300000000000000743ba40b00000000"

func PrintIotaBlock(block iotajsonrpc.IotaProgrammableTransactionBlock) {
	fmt.Println("IotaProgrammableTransactionBlock:")

	// Print Inputs
	fmt.Println("Inputs:")
	for i, input := range block.Inputs {
		fmt.Printf("%d) ", i)
		prettyPrint(input, 1)
		fmt.Println()
	}

	// Print Commands
	fmt.Println("Commands:")
	for i, command := range block.Commands {
		fmt.Printf("%d) ", i)
		prettyPrint(command, 1)
		fmt.Println()
	}
}

func prettyPrint(v interface{}, indent int) {
	padding := strings.Repeat("  ", indent)

	switch val := v.(type) {
	case map[string]interface{}:
		fmt.Println()
		for key, value := range val {
			fmt.Printf("%s%s: ", padding, key)
			prettyPrint(value, indent+1)
		}
	case []interface{}:
		if len(val) == 0 {
			fmt.Println("[]")
			return
		}
		fmt.Println()
		for _, item := range val {
			fmt.Printf("%s- ", padding)
			prettyPrint(item, indent+1)
		}
	case map[interface{}]interface{}:
		fmt.Println()
		for key, value := range val {
			fmt.Printf("%s%v: ", padding, key)
			prettyPrint(value, indent+1)
		}
	default:
		fmt.Printf("%v\n", val)
	}
}

func dryRunL1MigrationTransactionAndValidate(ctx context.Context, packageID iotago.PackageID, kp wallets.Wallet, l1Client clients.L1Client) {
	result, err := l1Client.DryRunTransaction(ctx, lo.Must(hexutil.Decode(TEST_TX)))
	log.Check(err)
	ownAddress := kp.Address().AsIotaAddress()

	if !result.Input.Data.V1.Sender.Equals(*ownAddress) {
		log.Fatal("The L1 migration sender address does not match the cli users address!")
	}

	log.Printf("[Check] Printing the transactions PTB inputs/commands.\n")
	PrintIotaBlock(*result.Input.Data.V1.Transaction.Data.ProgrammableTransaction)

	log.Printf("[Check] The cli users address matches the transaction senders address!\n")

	// This is a bit hacky, but there is no nicer way to do this.
	// Check if the assetsbag type used in the PTB is from the same PackageID as configured in the wasp-cli
	newAssetsBag := result.Input.Data.V1.Transaction.Data.ProgrammableTransaction.Commands[0].(map[string]interface{})
	moveCall := newAssetsBag["MoveCall"].(map[string]interface{})
	moveCallPackageID := moveCall["package"]

	testPackageID, err := iotago.PackageIDFromHex(moveCallPackageID.(string))
	if err != nil {
		log.Fatal("Could not parse the package id of the PTB")
	}

	if !bytes.Equal(packageID.Bytes(), testPackageID.Bytes()) {
		log.Fatalf("The package id configured in the wasp-cli is different to the one in the PTB! own:[%s], ptb:[%s]", packageID.String(), testPackageID.String())
	}

	log.Printf("[Check] The configured package id matches the one in the PTB.")
}

func executeAssetsBagMigration(ctx context.Context, packageID iotago.PackageID, kp wallets.Wallet, l1Client clients.L1Client, gasCoin *iotago.ObjectRef) (*iotago.ObjectRef, error) {
	const debug = true

	if debug {
		return l1Client.L2().CreateAndFillAssetsBagWithBaseTokens(ctx, &iscmoveclient.CreateAndFillAssetsBagWithBaseTokens{
			PackageID:   packageID,
			Signer:      kp,
			GasPayments: []*iotago.ObjectRef{gasCoin},
			Amount:      500_000_0,
			GasBudget:   iotaclient.DefaultGasBudget,
			GasPrice:    iotaclient.DefaultGasPrice,
		})
	}

	return nil, nil
}

func getFirstCoin(ctx context.Context, kp wallets.Wallet, client clients.L1Client, excludedCoin *iotago.ObjectID) *iotago.ObjectRef {
	coinType := iotajsonrpc.IotaCoinType.String()
	coins := lo.Must(client.GetCoins(ctx, iotaclient.GetCoinsRequest{
		CoinType: &coinType,
		Owner:    kp.Address().AsIotaAddress(),
	}))

	// This is only used for the GasCoin in the Prepare->Run transition.
	// We don't want to accidentally use the destined GasCoin for the Committee to pay for transactions.
	if excludedCoin != nil {
		var selectedCoin *iotago.ObjectRef

		lo.Filter(coins.Data, func(item *iotajsonrpc.Coin, index int) bool {
			if bytes.Equal(item.CoinObjectID.Bytes(), excludedCoin.Bytes()) {
				return true
			}

			selectedCoin = item.Ref()
			return false
		})

		return selectedCoin
	}

	return coins.Data[0].Ref()
}

/*
*
The prepare function is responsible for
* running the L1 migration
* creating the initial empty Anchor object
* initialize the chain state
* return a configuration object to the L2 migration tool
*/
func migrationPrepare(ctx context.Context, node string, packageID iotago.PackageID, kp wallets.Wallet, l1Client clients.L1Client, peers []string, quorum int) {
	cwd, err := os.Getwd()
	log.Check(err)

	dkgCommitteeAddress := doDKG(ctx, node, peers, quorum)

	fmt.Println("Execute Asset migration")
	assetsBagRef, err := executeAssetsBagMigration(ctx, packageID, kp, l1Client, getFirstCoin(ctx, kp, l1Client, nil)) // The returned assetsbag ref from the executed transaction.
	log.Check(err)

	// Just used to make sure that the migration request has solidified
	_, _ = l1Client.GetObjectWithRetry(ctx, iotaclient.GetObjectRequest{
		ObjectID: assetsBagRef.ObjectID,
	})

	fmt.Println("Creating Anchor")
	anchor, err := l1Client.L2().StartNewChain(ctx, &iscmoveclient.StartNewChainRequest{
		PackageID:         packageID,
		GasPayments:       []*iotago.ObjectRef{getFirstCoin(ctx, kp, l1Client, nil)},
		ChainOwnerAddress: kp.Address(),
		Signer:            kp,
		GasPrice:          iotaclient.DefaultGasPrice,
		GasBudget:         iotaclient.DefaultGasBudget,
		StateMetadata:     make([]byte, 0),
		InitCoinRef:       nil,
	})
	log.Check(err)

	l1Params, err := parameters.FetchLatest(context.Background(), l1Client.IotaClient())
	log.Check(err)

	fmt.Println("Creating GasCoin")
	gasCoin, err := cliutil.CreateAndSendGasCoin(ctx, l1Client, kp, kp.Address().AsIotaAddress(), l1Params)

	log.Check(err)

	prepareConfiguration := &migration.PrepareConfiguration{
		DKGCommitteeAddress: dkgCommitteeAddress,
		AnchorID:            anchor.ObjectID,
		AssetsBagID:         assetsBagRef.ObjectID,
		GasCoinID:           &gasCoin,
		ChainOwner:          kp.Address(),
		PackageID:           packageID,
		L1ApiUrl:            config.L1APIAddress(),
	}

	fmt.Println("Preparation finished:")
	serializeConfig := lo.Must(json.MarshalIndent(prepareConfiguration, "", "  "))
	fmt.Println(string(serializeConfig))
	log.Check(os.WriteFile("migration_preparation.json", serializeConfig, 0644))

	fmt.Printf("The 'migration_preperation.json' file has been written to your current cwd (%s)", cwd)
}

func migrationRun(ctx context.Context, node string, chainName string, packageID iotago.PackageID, kp wallets.Wallet, l1Client clients.L1Client) {
	configBytes := lo.Must(os.ReadFile("migration_preparation.json"))
	var prepareConfig migration.PrepareConfiguration
	log.Check(json.Unmarshal(configBytes, &prepareConfig))

	resultBytes := lo.Must(os.ReadFile("migration_result.json"))
	var migrationResult migration.MigrationResult
	log.Check(json.Unmarshal(resultBytes, &migrationResult))

	anchor, err := l1Client.GetObject(ctx, iotaclient.GetObjectRequest{
		ObjectID: prepareConfig.AnchorID,
	})
	log.Check(err)

	anchorRef := anchor.Data.Ref()

	stateMetadata, err := transaction.StateMetadataFromBytes(hexutil.MustDecode(migrationResult.StateMetadataHex))
	log.Check(err)
	stateMetadata.GasCoinObjectID = prepareConfig.GasCoinID

	// Update the StateAnchor with the latest migrated block info
	success, err := l1Client.L2().UpdateAnchorStateMetadata(ctx, &iscmoveclient.UpdateAnchorStateMetadataRequest{
		AnchorRef:     &anchorRef,
		StateMetadata: stateMetadata.Bytes(),
		StateIndex:    migrationResult.StateIndex,
		PackageID:     packageID,
		Signer:        kp,
		GasBudget:     iotaclient.DefaultGasBudget,
		GasPrice:      iotaclient.DefaultGasPrice,
		GasPayments: []*iotago.ObjectRef{
			getFirstCoin(ctx, kp, l1Client, prepareConfig.GasCoinID),
		},
	})

	if !success || err != nil {
		log.Printf("FAILED TO UPDATE STATE! result:%v, \nerr:%v", success, err)
		panic("omg")
	}

	// Transfer the GasCoin to the Committee
	transferGasCoin, err := l1Client.TransferObject(ctx, iotaclient.TransferObjectRequest{
		Signer:    kp.Address().AsIotaAddress(),
		ObjectID:  prepareConfig.GasCoinID,
		Recipient: prepareConfig.DKGCommitteeAddress.AsIotaAddress(),
		GasBudget: iotajsonrpc.NewBigInt(iotaclient.DefaultGasBudget),
		Gas:       getFirstCoin(ctx, kp, l1Client, prepareConfig.GasCoinID).ObjectID,
	})
	if err != nil {
		log.Printf("FAILED TO CONSTRUCT -TRANSFER ANCHOR-: err:%v", err)
		panic("omg")
	}

	result, err := l1Client.SignAndExecuteTransaction(ctx, &iotaclient.SignAndExecuteTransactionRequest{
		Signer:      cryptolib.SignerToIotaSigner(kp),
		TxDataBytes: transferGasCoin.TxBytes,
		Options: &iotajsonrpc.IotaTransactionBlockResponseOptions{
			ShowObjectChanges: true,
		},
	})
	if err != nil {
		log.Printf("FAILED TO EXECUTE -TRANSFER GASCOIN-: err:%v", err)
		panic("omg")
	}

	// Transfer the Anchor to the Committee
	transferAnchor, err := l1Client.TransferObject(ctx, iotaclient.TransferObjectRequest{
		Signer:    kp.Address().AsIotaAddress(),
		ObjectID:  anchorRef.ObjectID,
		Recipient: prepareConfig.DKGCommitteeAddress.AsIotaAddress(),
		GasBudget: iotajsonrpc.NewBigInt(iotaclient.DefaultGasBudget),
		Gas:       getFirstCoin(ctx, kp, l1Client, prepareConfig.GasCoinID).ObjectID,
	})
	if err != nil {
		log.Printf("FAILED TO CONSTRUCT -TRANSFER ANCHOR-: err:%v", err)
		panic("omg")
	}

	result, err = l1Client.SignAndExecuteTransaction(ctx, &iotaclient.SignAndExecuteTransactionRequest{
		Signer:      cryptolib.SignerToIotaSigner(kp),
		TxDataBytes: transferAnchor.TxBytes,
		Options: &iotajsonrpc.IotaTransactionBlockResponseOptions{
			ShowObjectChanges: true,
		},
	})
	if err != nil {
		log.Printf("FAILED TO EXECUTE -TRANSFER ANCHOR-: err:%v", err)
		panic("omg")
	}

	log.Printf("\n%v\n %v\n", transferAnchor, result)

	chainID := isc.ChainIDFromObjectID(*prepareConfig.AnchorID)
	config.AddChain(chainName, chainID.String())
	activateChain(ctx, node, chainName, chainID)
}

func initMigrateDeployPrepareCmd() *cobra.Command {
	var (
		node             string
		peers            []string
		quorum           int
		evmChainID       uint16
		blockKeepAmount  int32
		govControllerStr string
		chainName        string
	)

	cmd := &cobra.Command{
		Use:   "migrate-chain --chain=<name> 1) prepare, 2) run",
		Short: "Migrates a Stardust chain to Rebased",
		Args:  cobra.ExactArgs(1),
		Run: func(cmd *cobra.Command, args []string) {
			node = waspcmd.DefaultWaspNodeFallback(node)
			chainName = defaultChainFallback(chainName)
			ctx, cancel := context.WithTimeout(context.Background(), 1*time.Minute)
			defer cancel()

			if !util.IsSlug(chainName) {
				log.Fatalf("invalid chain name: %s, must be in slug format, only lowercase and hyphens, example: foo-bar", chainName)
			}

			l1Client := cliclients.L1Client()
			kp := wallet.Load()
			packageID := config.GetPackageID()

			/**
			Stardust -> Rebased migration

			1) Use the TypeScript L1 AliasOutput migration tool (tools/l1_migration), which prints unsigned, hex-encoded transaction data.
			2) Execute the transaction right here using the wallet which owns the AliasOutput (Governor Address)
			3) Receive the AssetsBag after the transaction has been executed.
			4) Store the AssetsBagRef
			5) CreateAndSendGasCoin
			6) CreateAnchorWithAssetsBagRef(assetsBagRef)
			7) Migrate the StateDB using the ChainID returned from CreateAnchorWithAssetsBagRef
			8) Extract the StateMetadata out of the StateDB Migration
			9) Update the Anchor using UpdateAnchorStateMetadata
			10) Proceed like a normal deployment (Activate chain on all nodes)
			*/

			if args[0] == "prepare" {
				migrationPrepare(ctx, node, packageID, kp, l1Client, peers, quorum)
				return
			}

			if args[0] == "run" {
				migrationRun(ctx, node, chainName, packageID, kp, l1Client)
				return
			}

		},
	}

	waspcmd.WithWaspNodeFlag(cmd, &node)
	waspcmd.WithPeersFlag(cmd, &peers)
	cmd.Flags().Uint16VarP(&evmChainID, "evm-chainid", "", evm.DefaultChainID, "ChainID")
	cmd.Flags().Int32VarP(&blockKeepAmount, "block-keep-amount", "", governance.DefaultBlockKeepAmount, "Amount of blocks to keep in the blocklog (-1 to keep all blocks)")
	cmd.Flags().StringVar(&chainName, "chain", "", "name of the chain")
	log.Check(cmd.MarkFlagRequired("chain"))
	cmd.Flags().IntVar(&quorum, "quorum", 0, "quorum (default: 3/4s of the number of committee nodes)")
	cmd.Flags().StringVar(&govControllerStr, "gov-controller", "", "governance controller address")
	return cmd
}
