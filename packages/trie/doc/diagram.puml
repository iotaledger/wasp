@startuml
allow_mixing

struct TrieR {
  store: KVReader
}

struct NodeData {
  {field} pathExtension: []byte
  terminal: Tcommitment
  children: [16]Hash
  commitment: Hash
}

struct Tcommitment {
  data: []byte
  isValue: bool
}

note top of Tcommitment
  data is either:
  - value (if len(value) < 63)
  - hash(value)

  serialized as [header|data]
  where header = [isValue (1 bit) | len(data) (7 bits)]
end note

struct Hash {}

note left of Hash
  [20]byte hash
end note

package db <<Database>> {
  folder 0 {
    database trieNodes
  }
  folder 1 {
    database trieValues
  }
  folder 2 {
    database nodeRefcounts
  }
  folder 3 {
    database valueRefcounts
  }
}

NodeData ..> trieNodes: "k=commitment\nv=nodeData.Bytes()"
NodeData ..> nodeRefcounts
Tcommitment ..> trieValues: "(if !isValue)\nk=hash(value)\nv=value"
Tcommitment ..> valueRefcounts
NodeData "1" *-- "1" Tcommitment: terminal
NodeData "1" *-- "1" Hash: commitment
NodeData "1" *-- "16" Hash: children
TrieR ..> NodeData: manages
@enduml
